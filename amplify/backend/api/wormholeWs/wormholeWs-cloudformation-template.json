{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "API Gateway resource stack creation using Amplify CLI",
  "Parameters": {
    "env": {
      "Type": "String"
    },
    "functionwormholeApiHandlerName": {
      "Type": "String"
    }
  },
  "Conditions": {
    "ShouldNotCreateEnvResources": {
      "Fn::Equals": [
        {
          "Ref": "env"
        },
        "NONE"
      ]
    }
  },
  "Resources": {
    "wormholeWs": {
      "Type": "AWS::ApiGatewayV2::Api",
      "Properties": {
        "Name": {
          "Fn::Sub": [
            "wormholeWs-${env}",
            {
              "env": {
                "Ref": "env"
              }
            }
          ]
        },
        "Description": "Wormhole WebSocket API",
        "ProtocolType": "WEBSOCKET",
        "RouteSelectionExpression": "$request.body.action",
        "Target": {
          "Fn::Sub": [
            "arn:aws:apigateway:${region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${region}:${account}:function:${functionwormholeApiHandlerName}/invocations",
            {
              "region": {
                "Ref": "AWS::Region"
              },
              "account": {
                "Ref": "AWS::AccountId"
              },
              "functionwormholeApiHandlerName": {
                "Ref": "functionwormholeApiHandlerName"
              }
            }
          ]
        }
      }
    },
    "ConnectRoute": {
      "Type": "AWS::ApiGatewayV2::Route",
      "Properties": {
        "ApiId": {
          "Ref": "wormholeWs"
        },
        "RouteKey": "$connect",
        "AuthorizationType": "AWS_IAM",
        "OperationName": "ConnectRoute",
        "Target": {
          "Fn::Join": [
            "/",[
              "integrations", {
                "Ref": "ConnectInteg"
              }
            ]
          ]
        }
      }
    },
    "ConnectInteg": {
      "Type": "AWS::ApiGatewayV2::Integration",
      "Properties": {
        "ApiId": {"Ref": "wormholeWs"},
        "Description": "Connect Integration",
        "IntegrationType": "AWS_PROXY",
        "IntegrationUri": {
          "Fn::Sub": [
            "arn:aws:apigateway:${region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${region}:${account}:function:${functionwormholeApiHandlerName}/invocations",
            {
              "region": {
                "Ref": "AWS::Region"
              },
              "account": {
                "Ref": "AWS::AccountId"
              },
              "functionwormholeApiHandlerName": {
                "Ref": "functionwormholeApiHandlerName"
              }
            }
          ]
        }
      }
    },
    "DisconnectRoute": {
      "Type": "AWS::ApiGatewayV2::Route",
      "Properties": {
        "ApiId": {
          "Ref": "wormholeWs"
        },
        "RouteKey": "$disconnect",
        "AuthorizationType": "NONE",
        "OperationName": "DisconnectRoute",
        "Target": {
          "Fn::Join": [
            "/", ["integrations", {
              "Ref": "DisconnectInteg"
            }]
          ]
        }
      }
    },
    "DisconnectInteg": {
      "Type": "AWS::ApiGatewayV2::Integration",
      "Properties": {
        "ApiId": {"Ref": "wormholeWs"},
        "Description": "Disconnect Integration",
        "IntegrationType": "AWS_PROXY",
        "IntegrationUri": {
          "Fn::Sub": [
            "arn:aws:apigateway:${region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${region}:${account}:function:${functionwormholeApiHandlerName}/invocations",
            {
              "region": {
                "Ref": "AWS::Region"
              },
              "account": {
                "Ref": "AWS::AccountId"
              },
              "functionwormholeApiHandlerName": {
                "Ref": "functionwormholeApiHandlerName"
              }
            }
          ]
        }
      }
    },
    "SendRoute": {
      "Type": "AWS::ApiGatewayV2::Route",
      "Properties": {
        "ApiId": {
          "Ref": "wormholeWs"
        },
        "RouteKey": "sendmessage",
        "AuthorizationType": "NONE",
        "OperationName": "SendRoute",
        "Target": {
          "Fn::Join": [
            "/", ["integrations", {
              "Ref": "SendInteg"
            }]
          ]
        }
      }
    },
    "SendInteg": {
      "Type": "AWS::ApiGatewayV2::Integration",
      "Properties": {
        "ApiId": {"Ref": "wormholeWs"},
        "Description": "Send Message Integration",
        "IntegrationType": "AWS_PROXY",
        "IntegrationUri": {
          "Fn::Sub": [
            "arn:aws:apigateway:${region}:lambda:path/2015-03-31/functions/arn:aws:lambda:${region}:${account}:function:${functionwormholeApiHandlerName}/invocations",
            {
              "region": {
                "Ref": "AWS::Region"
              },
              "account": {
                "Ref": "AWS::AccountId"
              },
              "functionwormholeApiHandlerName": {
                "Ref": "functionwormholeApiHandlerName"
              }
            }
          ]
        }
      }
    },
    "Deployment": {
      "Type": "AWS::ApiGatewayV2::Deployment",
      "DependsOn": [
        "ConnectRoute",
        "SendRoute",
        "DisconnectRoute"
      ],
      "Properties": {
        "ApiId": {
          "Ref": "wormholeWs"
        }
      }
    },
    "Stage": {
      "Type": "AWS::ApiGatewayV2::Stage",
      "Properties": {
        "StageName": {
          "Ref": "env"
        },
        "Description": {
          "Fn::Join": [
            "",
            [
              {
                "Ref": "env"
              }
            ]
          ]
        },
        "DeploymentId": {
          "Ref": "Deployment"
        },
        "ApiId": {
          "Ref": "wormholeWs"
        }
      }
    },
    "functionwormholeApiHandlerPermissionwormholeWs": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName": {
          "Ref": "functionwormholeApiHandlerName"
        },
        "Action": "lambda:InvokeFunction",
        "Principal": "apigateway.amazonaws.com",
        "SourceArn": {
          "Fn::Join": [
            "",
            [
              "arn:aws:execute-api:",
              {
                "Ref": "AWS::Region"
              },
              ":",
              {
                "Ref": "AWS::AccountId"
              },
              ":",
              {
                "Ref": "wormholeWs"
              },
              "/",
              {
                "Ref": "env"
              },
              "/*"
            ]
          ]
        }
      }
    }
  },
  "Outputs": {
    "RootUrl": {
      "Description": "Root URL of the API gateway",
      "Value": {"Fn::Join": ["", ["https://", {"Ref": "wormholeWs"}, ".execute-api.", {"Ref": "AWS::Region"}, ".amazonaws.com/", {"Fn::If": ["ShouldNotCreateEnvResources","Prod", {"Ref": "env"} ]}]]}
    },
    "ApiName": {
      "Description": "API Friendly name",
      "Value": "wormholeWs"
    },
    "ApiId": {
      "Description": "API ID (prefix of API URL)",
      "Value": {"Ref": "wormholeWs"}
    }
  }
}
